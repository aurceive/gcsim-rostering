# weapon_roster: документация по конфигам (examples)

Эта папка содержит **эталонные примеры** конфигурационных файлов для приложения `weapon_roster`.

- `config.example.txt` — текстовый конфиг симуляции (формат gcsim/wfpsim/wfpsim-custom/custom). Это «шаблон» ротации/команды, который программа будет многократно запускать, **подменяя оружие, пробуждение и мейн-статы**.
- `roster_config.example.yaml` — YAML-настройки перебора (кого оптимизируем, какие мейн-статы перебирать, какой движок использовать и т.п.).

> Если у вас нет `input/weapon_roster/config.txt` и/или `input/weapon_roster/roster_config.yaml`, их можно создать из этих примеров скриптом `scripts/weapon_roster/bootstrap.ps1`.

---

## Как это работает (коротко)

1. Программа читает `input/weapon_roster/config.txt` как обычный конфиг симулятора.
2. Из него она вытаскивает **порядок персонажей** по строкам вида `<char> char lvl=...`.
3. В `input/weapon_roster/roster_config.yaml` вы указываете:
   - `char`: какого персонажа оптимизируем
   - `main_stats`: список возможных мейн-статов на **пески/кубок/корону**
   - `target`: оптимизируем по `team_dps` или по личному урону (`personal_dps`/`char_dps`)
   - `engine` или `engine_path`: какой движок запускать
   - `minimum_weapon_rarity`: минимальная редкость оружия для перебора
4. Для каждого оружия (и для некоторых оружий — для нескольких пробуждений) и для каждой комбинации мейн-статов программа:
   - **временно правит** `config.txt` (в `work/temp_config.txt`),
   - запускает CLI движка,
   - собирает метрики и выбирает лучший результат.
5. Результат экспортируется в Excel-файл в `output/weapon_roster/`.

---

## 1) `roster_config.yaml` (YAML конфиг перебора)

Файл должен лежать по пути `input/weapon_roster/roster_config.yaml`.

### Поля

#### `engine` (опционально)

Строка. Если `engine_path` не задан, то движок берётся из `engines/<engine>`.

- допустимые значения в репозитории: `gcsim`, `wfpsim`, `wfpsim-custom`, `custom`
- если поле пустое/не задано — по умолчанию используется `gcsim`

#### `engine_path` (опционально)

Строка-путь до корня репозитория движка.

- если задано (не пустое), то `engine` игнорируется
- путь считается корректным, если существует файл:
  - `ui/packages/ui/src/Data/weapon_data.generated.json`

Используйте это поле, если вы хотите указывать отдельную локальную копию движка.

#### `char` (обязательно)

Ключ персонажа, которого оптимизируем.

Важно:

- значение должно совпадать с ключом персонажа в данных движка (как правило, lower-case ключи)
- это же значение **должно встречаться в `config.txt`**:
  - в строке `<char> char lvl=...`
  - в строке `<char> add weapon="..." ...`
  - в строке `<char> add stats hp=... atk=... <sands> <goblet> <circlet> ...`

#### `roster_name` (обязательно)

Имя ростера. Используется только для имени файла результата:

`output/weapon_roster/<YYYYMMDD>_weapon_roster_<char>_<roster_name>.xlsx`

Рекомендации для Windows:

- избегайте символов `<>:"/\\|?*`, иначе сохранение `.xlsx` может упасть
- избегайте очень длинных строк

#### `minimum_weapon_rarity` (опционально)

Минимальная редкость оружия, которое будет перебрано.

- если `<= 0` или поле отсутствует — по умолчанию будет `3`
- типичные значения: `3`, `4`, `5`

#### `weapons` (опционально)

Список строк. Ограничивает перебор конкретными оружиями.

- каждый элемент — это либо ключ оружия, либо точное русское имя (полное совпадение)
- если список задан, `minimum_weapon_rarity` игнорируется, но класс оружия всё равно проверяется

Дополнительно можно задать конкретные пробуждения, добавив числа в конец строки:

```yaml
- skywardharp 2
- skywardharp 3
- skywardharp 2 3
- skywardharp
```

Правила:

- если пробуждения не указаны — берутся «стандартные» для этого оружия (по планировщику)
- если указаны пробуждения, берутся только они
- если есть и записи без пробуждений, и записи с пробуждениями — используется объединение

#### `skip_existing_results` (опционально)

Булево значение. Если задано `true`, то пары `weapon+refine`, которые уже есть в базовой таблице
(`base_table_path` или существующий `output_table_path`), **не пересчитываются**.

Полезно для продолжения прерванного расчёта.

#### `target` (опционально)

Список строк (YAML array). Определяет, по чему выбирать лучший результат.

Поддерживается:

- `team_dps` — оптимизировать по DPS команды
- `char_dps` или `personal_dps` — оптимизировать по личному DPS оптимизируемого персонажа

Логика:

- если `target` пустой или не задан — по умолчанию **личный DPS**
- если в списке присутствует `team_dps` — выбирается **командный DPS** (даже если рядом есть `personal_dps`)
- если указан неизвестный элемент — будет ошибка с перечислением поддерживаемых значений

#### `main_stats` (обязательно)

Три списка строк:

- `main_stats.sands` — пески
- `main_stats.goblet` — кубок
- `main_stats.circlet` — корона

Каждый элемент — это **один токен** вида `ключ=значение`, например:

- `atk%=0.466`
- `er=0.518`
- `em=187`
- `pyro%=0.466`, `electro%=0.466`, …
- `cr=0.311`, `cd=0.622`
- `heal=0.359`

Комбинации перебираются как декартово произведение списков:

`sands[i] + " " + goblet[j] + " " + circlet[k]`

Важные требования:

- в каждом из трёх списков должен быть **хотя бы один** элемент, иначе перебор мейн-статов будет пустым
- элементы должны быть без пробелов (это именно «токены»)

#### `substat_optimizer_variants` (опционально)

Список вариантов настроек оптимизатора подстатов движка (CLI флаг `-options`).

Зачем это нужно:

- движки поддерживают дополнительные опции оптимизации подстатов (например `total_liquid_substats`, `fine_tune` и т.п.)
- `weapon_roster` может прогонять **один и тот же перебор оружий/мейн-статов** для нескольких наборов этих опций
- в итоговом Excel на каждый вариант будет свой блок колонок: `Team DPS / Team % / Char DPS / Char % / ER at 0s / Main Stats`

Формат элемента списка:

- `name` (обязательно): имя варианта (должно быть уникальным)
- `options` (опционально): map из `option -> value`, который будет преобразован в строку `key=value;key2=value2` и передан как `-options <строка>`

Дополнительно поддерживается специальная настройка (не передаётся в `-options`):

- `options.talent_level` (опционально): целое число 1..10. Если задано, то перед каждым запуском симуляции всем персонажам отряда выставляется `talent=<L>,<L>,<L>` независимо от того, что было указано в `config.txt`. Если не задано — таланты остаются как в исходном конфиге симуляции.

Если секция отсутствует, используется один вариант `default` без передачи `-options` (поведение как раньше).

Пример:

```yaml
substat_optimizer_variants:
  - name: kqms
  - name: default
    options:
      talent_level: 9
      total_liquid_substats: 20
      indiv_liquid_cap: 10
      fixed_substats_count: 2
      fine_tune: 1
      show_substat_scalars: 1
```

### Минимальный пример

```yaml
engine: wfpsim
char: fischl
roster_name: overload
minimum_weapon_rarity: 5
target:
  - personal_dps
main_stats:
  sands:
    - atk%=0.466
  goblet:
    - electro%=0.466
  circlet:
    - cr=0.311
```

---

## 2) `config.txt` (текстовый конфиг симуляции)

Файл должен лежать по пути `input/weapon_roster/config.txt`.

Это обычный конфиг для движка (gcsim/wfpsim/wfpsim-custom/custom) с ротацией, целями, опциями и т.д.
Приложение `weapon_roster` **не парсит весь формат**, а делает очень конкретные вещи:

1) определяет порядок персонажей по строкам, которые содержат подстроку:

- `char lvl=`

1) у оптимизируемого персонажа подменяет:

- строку оружия: `<char> add weapon="..." refine=... ...;`
- строку «main stats» (мейн-статы артефактов) вида: `<char> add stats hp=... atk=... <sands> <goblet> <circlet> ...`

### 2.1 Порядок персонажей (важно для `char_dps`)

Порядок персонажей берётся так:

- программа ищет строки, где встречается `char lvl=`
- первый токен строки считается именем персонажа
- дальше этот порядок используется, чтобы взять правильный индекс в результате симуляции

Пример (порядок: arlecchino, chevreuse, fischl, bennett):

```txt
arlecchino char lvl=90/90 cons=0 talent=9,9,9 ;
chevreuse char lvl=90/90 cons=6 talent=9,9,9;
fischl char lvl=90/90 cons=6 talent=9,9,9;
bennett char lvl=90/90 cons=6 talent=9,9,9;
```

Если `char` в YAML не найден среди этих строк — будет ошибка `character <char> not found in config`.

### 2.2 Строка оружия (обязательно, в строгом формате)

Для оптимизируемого персонажа **должна быть** строка, начинающаяся с:

- `<char> add`

и содержащая `weapon="..."`.

Пример:

```txt
fischl add weapon="thestringless" refine=5 lvl=90/90;
```

Что делает программа:

- заменяет значение в `weapon="..."` на перебираемое оружие
- удаляет любой существующий `refine=<число>` в строке и добавляет `refine=<нужное>`

Если строка оружия не найдена — будет ошибка вида `weapon line for character <char> not found in config`.

### 2.3 Строка main stats (обязательно, с ограничениями)

Для оптимизируемого персонажа должна быть строка:

- начинающаяся с `<char> add stats`
- содержащая как минимум 5 токенов после `add stats`:
  1) `hp=4780` **или** `hp=3571` (строго)
  2) `atk=311` (или иной токен atk, но он будет сохранён как «второй токен»)
  3) токен песков
  4) токен кубка
  5) токен короны

Пример:

```txt
fischl add stats hp=4780 atk=311 atk%=0.466 electro%=0.466 cr=0.311 ; #main
```

Что делает программа:

- оставляет первые два токена (обычно `hp=4780 atk=311`)
- **заменяет ровно три токена** (3..5) на комбинацию из YAML: `sands goblet circlet`
- всё, что после 5-го токена (включая `;` и комментарии), сохраняет как есть

Жёсткие требования:

- «комбо мейн-статов» должно быть **ровно 3 токена** (по одному на слот)
- первый токен HP должен быть **строго** `hp=4780` или `hp=3571` (иначе строка не будет считаться строкой main stats для замены)

Если строка не подходит — будет ошибка вида:
`failed to replace main stats for character <char> with "..."`

---

## 3) Частые проблемы и как их быстро диагностировать

### Персонаж не найден

Ошибка: `character <char> not found in config`

Проверьте:

- в `config.txt` есть строка `<char> char lvl=...`
- в YAML поле `char` совпадает с первым токеном (учитывается регистр)

### Не найдена строка оружия

Ошибка: `weapon line for character <char> not found in config`

Проверьте, что у персонажа есть строка в стиле:

`<char> add weapon="..." refine=... ...;`

### Не заменяются main stats

Ошибка: `failed to replace main stats...`

Проверьте, что строка main stats:

- начинается с `<char> add stats`
- имеет первые два токена как `hp=4780 atk=...` (или `hp=3571 ...`)
- имеет **три** токена подряд для sands/goblet/circlet

---

## 4) Дополнительно: `data/weapon_sources_ru.yaml`

Это не «конфиг перебора», но он влияет на:

- какие пробуждения будут считаться (для некоторых 4* оружий перебираются `r1` и `r5`, для других только `r5`)
- какие 4* оружия считаются «доступными» при расчёте процентов в итоговом Excel

Если для каких-то 4* оружий нет записей, программа:

- допишет заглушки вида `weapon_key: []`
- попросит заполнить источники и перезапустить

Допустимые источники (строки) сейчас такие:

- `Стандартная молитва`
- `Магазин Паймон`
- `Ковка`
- `Ивент`
- `Ивентовая оружейная молитва`
- `БП`
- `ПС5`
- `Квесты`
- `Рыбалка`
